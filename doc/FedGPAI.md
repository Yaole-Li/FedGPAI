#### 总体结构：
参考 FedRep 与 FedPer，都是参数解耦的结构,都分特征提取器和回归器两部分
将模型分解为全局共享的特征提取器和局部私有的回归器两部分
Server 动作：聚合所有的客户端的总体模型
Client 动作：将本地的特征提取器直接替换为全局的特征提取器；根据自身的独特数据个性化调整回归器
在每一轮中，每个客户端得到 全局模型 和 全局模型的特征提取器加上上一轮的本地模型的回归器组成的本地模型
利用本地数据组成分别计算上述两个模型的损失，反向传播得到模型回归器参数的梯度，再计算出回归器中每一个参数的梯度幅度
根据上述两个模型的梯度幅度，评估全局模型和混合模型回归器对本地数据的重要程度，确定每个参数的插值比例，生成本地回归器
算法如下:
```
算法 3.1 基于自适应个性化联邦学习的气压传感器校正

输入: N个客户端，初始全局模型θ^0，联邦训练轮数T
输出: 个性化本地模型θ̂_1,...,θ̂_N

1.  for t ← 0, ..., T - 1 do
2.      服务器发送θ^t给所有参与的客户端
3.      for 客户端i ← 1, ⋯, N do
4.          θ^t ← (ω^t, φ^t)//全局模型
5.          θ_i^t ← (ω^t, φ_i^{t-1})//φ_i^{t-1}是t-1轮客户端i的回归器
6.          /*计算模型梯度幅度*/
7.          g_g, g_i ← update(θ^t, θ_i^t, D_i)//算法 3.2
8.          /*逐参数插值*/
9.          φ̂_i^t ← model_interpolation (g_g, g_i)//算法 3.3
10.         客户端i获得初始模型θ̂_i^t = (ω^t, φ̂_i^t)
11.         θ̂_i^t ← θ̂_i^t - α∇_{θ_i}L(θ̂_i^t; D_i)//本地训练
12.         客户端i发送θ̂_i^t至中央服务器
13.     end for
14.     服务器聚合客户端模型θ^{t+1} ← \frac{1}{N}\sum_{i=1}^N θ̂_i^t
15. end for
16. return θ̂_1, ..., θ̂_N
```


#### 如何评估全局模型和混合模型回归器对本地数据的重要程度？
基于梯度幅度的评估机制
在每一轮的 Client 中：
利用全局模型的特征提取器和本地模型的回归器搭建混合模型
对混合模型的回归器进行适配性微调以加强与全局特征提取器的协同性
使用客户端的本地数据集分别通过全局模型和混合模型计算损失值
反向传播计算全局模型回归器与混合模型回归器的参数梯度
计算每个回归器参数梯度的 L2 范数来衡量梯度幅度
最终全局模型回归器与混合模型回归器所对应的参数梯度的 L2 范数就是评判标准，梯度幅值越大，参数当前值偏离最优值的程度越高
若全局模型的梯度幅度值大，这表明混合模型中本地回归器对本地数据的损失影响微弱，更适配本地数据分布，需保留其个性化特性，以便进一步优化性能；若混合模型的梯度幅度值大，则说明全局模型中全局回归器已较好适配本地数据，接近最优值，可增强其权重以提升泛化能力。
算法如下：
```
算法 3.2 基于梯度幅度的参数重要性评估

输入: 全局模型θ_g^t， 上一轮本地模型θ_i^{t-1}， 客户端i的本地数据集D_i
输出: 全局模型回归器梯度幅度g_g， 混合模型本地回归器梯度幅度g_i
1.  for 客户端i ← 1, ..., N do
2.      θ_g^t ← (ω_g^t, φ_g^t)
3.      θ_i^{t-1} ← (ω_i^{t-1}, φ_i^{t-1})
4.      φ_i^t ← φ_i^{t-1} - η∇_{φ_i^{t-1}}L(D_i; ω_g^t, φ_i^{t-1})// 回归器微调
5.      /*全局模型处理*/
6.      L_1 ← \frac{1}{N}\sum_{(x_i,y_i)\in D_i} L(x_i, y_i; ω_g^t, φ_g^t)// 全局模型损失
7.      ∇_{\phi_g^t}L_1 ← \frac{\partial L_1}{\partial \phi_g^t}// 全局模型回归器梯度
8.      g_g ← \|\|\nabla_{\phi_g^t}L_1\|\|_2// 全局模型回归器梯度幅度
9.      /*混合模型处理*/
10.     L_2 ← \frac{1}{N}\sum_{(x_i,y_i)\in D_i} L(x_i, y_i; ω_g^t, φ_i^t)// 混合模型损失
11.     ∇_{\phi_i^t}L_2 ← \frac{\partial L_2}{\partial \phi_i^t}// 混合模型回归器梯度
12.     g_i ← \|\|\nabla_{\phi_i^t}L_2\|\|_2// 混合模型回归器梯度幅度
13. end for
14. return g_g, g_i
```


#### 如何确定每个参数的插值比例?
基于逐参数自适应插值的策略
现在已经有了全局回归器和本地回归器的参数梯度幅度
计算差值权重α_j
根据差值权重生成个性化回归器最终参数
算法如下:
```
算法 3.3 基于逐参数自适应插值的个性化回归器优化

输入: 全局模型回归器梯度幅度g_g， 混合模型本地回归器梯度幅度g_i
输出: 个性化回归器φ̂_i^t
1.  for 客户端i ← 1, ..., N do
2.      /* 计算L2 范数 */
3.      L_g ← \sqrt{\sum_k(g_{g,k})^2}
4.      L_i ← \sqrt{\sum_k(g_{i,k})^2}
5.      for j ← 1, ..., M do// 遍历每个参数
6.          /* 归一化处理 */
7.          g_{g,j}^{\text{norm}} ← \frac{g_{g,j}}{L_g}
8.          g_{i,j}^{\text{norm}} ← \frac{g_{i,j}}{L_i}
9.          /* 计算插值权重 */
10.         \alpha_j ← 1 - \frac{g_{i,j}^{\text{norm}}}{g_{i,j}^{\text{norm}}+g_{g,j}^{\text{norm}}+\epsilon}
11.         /* 调整融合比例 */
12.         \hat{\phi}_{i,j}^t ← \alpha_j \times \phi_{i,j}^t + (1 - \alpha_j) \times \phi_{g,j}^t
13.     end for
14. end for
15. return φ̂_i^t
```

#### 训练方法
##### 数据集和模型介绍
为确保实验数据的真实性与可靠性，本研究采用了20支真实气压传感器，每支传感器采集了444条数据样本。每条数据样本包含气压频率、温度和真实气压值三项，其中真实气压值的采集范围为50 hPa至1550 hPa，相当于0.05至1.5个标准大气压，采集间隔为100 hPa；温度范围为-40℃至60℃，数据间隔为20℃。为了满足模型训练和测试的需求，采集到的数据被划分为训练集和测试集，其中384条数据作为训练数据，60条数据作为测试数据。
针对气压传感器数据特点，采用了全连接神经网络（Fully Connected Neural Network, FCN）模型架构。该模型以气压频率和温度作为输入特征，通过多层非线性变换实现对真实气压值的精确预测。
##### 个性化联邦学习设置
在本研究的个性化联邦学习框架中，由1个中央服务器与20个参与方协同工作的体系架构。其中，每一支用于数据采集的气压传感器均作为独立的参与方，即客户端。在联邦训练流程方面，全局联邦训练共50轮。在每一轮全局联邦训练过程中，中央服务器首先将当前全局模型的参数下发至各个客户端。各客户端在接收到参数后，利用自身本地所采集的数据开展本地训练。本地训练设置为5轮，在这5轮本地训练中，客户端基于自身数据特点，对模型参数进行调整与优化。